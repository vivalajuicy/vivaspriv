-- [[ VIVAS HUB PLS DONT STEAL OR ELSE IM GETTING U ON ME AND MY MOTHER NIGGERBITCH xoxo ]] --

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Lighting = game:GetService("Lighting")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local Camera = workspace.CurrentCamera

--// Globals
getgenv().SilentAim = false
getgenv().ShowFOV = false
getgenv().TargetKnocked = false
getgenv().FOVRadius = 111
local Whitelist = {}

-- [[ UI SETUP ]] --
local MainGui = Instance.new("ScreenGui", game.CoreGui)
local MainFrame = Instance.new("Frame", MainGui)
local UICorner = Instance.new("UICorner", MainFrame)
local UIStroke = Instance.new("UIStroke", MainFrame)

MainFrame.Name = "VivasMain"
MainFrame.Size = UDim2.new(0, 500, 0, 360)
MainFrame.Position = UDim2.new(0.5, -250, 0.5, -210)
MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Visible = false 

-- [[ INITIAL AD ]] --
local sgAd = Instance.new("ScreenGui", LocalPlayer.PlayerGui)
sgAd.Name = "Vivas_Ad"
sgAd.ResetOnSpawn = false
local adLabel = Instance.new("TextLabel", sgAd)
adLabel.Size = UDim2.new(1, 0, 1, 0)
adLabel.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
adLabel.BackgroundTransparency = 0.1
adLabel.Text = "finna gog poper sauce"
adLabel.TextColor3 = Color3.fromRGB(238, 238, 255)
adLabel.Font = Enum.Font.GothamBold
adLabel.TextSize = 44
adLabel.ZIndex = 100

task.delay(2.5, function()
    for i = 0, 1, 0.1 do
        adLabel.TextTransparency = i
        adLabel.BackgroundTransparency = i + 0.1
        task.wait(0.1)
    end
    sgAd:Destroy()
    MainFrame.Visible = true 
end)

-- [[ CONFIGS ]] --
local GlobalSettings = {
    Visible = true,
    HideAllKey = Enum.KeyCode.X 
}

local AvatarSettings = {
    SparkleColor = Color3.fromRGB(255, 20, 147),
    SparkleSize = 1,
    HeadlessActive = false,
    KorbloxActive = false
}

local FPSSettings = {
    MasterEnabled = true,
    TargetFPS = 240,
    CurrentFPS = 0
}

local TeleportSettings = {
    Enabled = false,
    FreeMouseTPKey = Enum.KeyCode.F1
}

local MagnetSettings = {
    MasterEnabled = false,
    Enabled = false,
    LockKey = Enum.KeyCode.Q,
    MagnetStrength = 1,
    TargetPart = "UpperTorso"
}

local FogPresets = {
    ["neon redish"] = {Color = Color3.fromRGB(255, 70, 70), Density = 0.45},    
    ["pretty pink pussy"] = {Color = Color3.fromRGB(255, 20, 147), Density = 0.48},  
    ["electric blue"] = {Color = Color3.fromRGB(0, 255, 255), Density = 0.51}, 
    ["fart colored gas"] = {Color = Color3.fromRGB(50, 255, 50), Density = 0.49},  
    ["a purple shade idfk"] = {Color = Color3.fromRGB(138, 43, 226), Density = 0.56}, 
    ["BLACK VOID"] = {Color = Color3.fromRGB(0, 0, 0), Density = 0.48}   
}

local OrigFogStart, OrigFogEnd, OrigFogColor = Lighting.FogStart, Lighting.FogEnd, Lighting.FogColor
local OrigAtmosphere = Lighting:FindFirstChildOfClass("Atmosphere") and Lighting:FindFirstChildOfClass("Atmosphere"):Clone() or nil

local TriggerSettings = {
    MasterEnabled = false,
    TriggerKey = Enum.KeyCode.T,
    Mode = "Hold",
    Active = false,
    ClickDelay = 0.03,
    Blacklist = {"Knife", "Wallet", "Phone", "Chicken", "Pizza", "Flashlight", "Medkit", "Blade", "Bat", "Punch", "Combat"}
}

local FlameConfig = {
    MasterLock = false,
    MasterSpeed = false,
    LockActive = false,
    SpeedActive = false,
    MouseLockKey = Enum.KeyCode.Z, 
    WalkSpeedKey = Enum.KeyCode.J,
    UseRightClick = false,
    ActivationType = "Hold", 
    Smoothness = 0.71,
    Prediction = 0.250,
    LeftOffset = 2.34,
    UpOffset = -10.53,
    HitPart = 'HumanoidRootPart',
    WalkSpeedValue = 100,
}

local ESPSettings = {
    Enabled = false,
    Box = false,
    Skeleton = false,
    Health = false,
    Name = false,
    Distance = false,
    TeamCheck = false,
    MaxDistance = 1000,
    BoxColor = Color3.fromRGB(20, 157, 255),
    SkeletonColor = Color3.fromRGB(20, 39, 255),
    NameColor = Color3.fromRGB(255, 255, 255)
}

local locations = {
    ["db"] = CFrame.new(-1039, 18, -256),
    ["armour"] = CFrame.new(-607, 7, -788),
    ["sg"] = CFrame.new(-582, 7, -733),
    ["tac"] = CFrame.new(485, 48, -615),
    ["mil"] = CFrame.new(35, 25, -840)
}

--// Silent Aim FOV Drawing
local FOVCircle = Drawing.new("Circle")
FOVCircle.Thickness = 1.5
FOVCircle.Color = Color3.fromRGB(255, 115, 148)
FOVCircle.Filled = false
FOVCircle.Transparency = 1
FOVCircle.Visible = false

UICorner.CornerRadius = UDim.new(0, 10)
UIStroke.Color = Color3.fromRGB(11, 12, 14)
UIStroke.Thickness = 1

local Sidebar = Instance.new("Frame", MainFrame)
Sidebar.Size = UDim2.new(0, 120, 1, 0)
Sidebar.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
Instance.new("UICorner", Sidebar).CornerRadius = UDim.new(0, 10)

local Title = Instance.new("TextLabel", Sidebar)
Title.Size = UDim2.new(1, 0, 0, 40)
Title.Text = "üÖ•üÖêüÖõüÖûüÖ°üÖòüÖî'üÖ¢ üÖóüÖ§üÖë"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 13
Title.BackgroundTransparency = 1

local SubTitle = Instance.new("TextLabel", Sidebar)
SubTitle.Size = UDim2.new(1, 0, 0, 20)
SubTitle.Position = UDim2.new(0, 0, 0, 35)
SubTitle.Text = "‚ô°"
SubTitle.TextColor3 = Color3.fromRGB(134, 214, 255)
SubTitle.Font = Enum.Font.GothamBold
SubTitle.TextSize = 16
SubTitle.BackgroundTransparency = 1

-- [[ SCROLLABLE SIDEBAR BUTTONS ]] --
local SidebarScroll = Instance.new("ScrollingFrame", Sidebar)
SidebarScroll.Size = UDim2.new(1, 0, 1, -110)
SidebarScroll.Position = UDim2.new(0, 0, 0, 60)
SidebarScroll.BackgroundTransparency = 1
SidebarScroll.ScrollBarThickness = 2
SidebarScroll.CanvasSize = UDim2.new(0, 0, 0, 400) 
local SidebarLayout = Instance.new("UIListLayout", SidebarScroll)
SidebarLayout.Padding = UDim.new(0, 5)
SidebarLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center

SidebarLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    SidebarScroll.CanvasSize = UDim2.new(0, 0, 0, SidebarLayout.AbsoluteContentSize.Y + 20)
end)

local Credits = Instance.new("TextLabel", Sidebar)
Credits.Size = UDim2.new(1, -10, 0, 40)
Credits.Position = UDim2.new(0, 5, 1, -45)
Credits.Text = "made by viva aka valorie\nany random nigger caught using this will die."
Credits.TextColor3 = Color3.fromRGB(126, 195, 255)
Credits.Font = Enum.Font.GothamMedium
Credits.TextSize = 9
Credits.BackgroundTransparency = 1
Credits.TextWrapped = true

local Container = Instance.new("Frame", MainFrame)
Container.Size = UDim2.new(1, -130, 1, -20)
Container.Position = UDim2.new(0, 125, 0, 10)
Container.BackgroundTransparency = 1

local Pages = {}
local function CreatePage(name)
    local Page = Instance.new("ScrollingFrame", Container)
    Page.Size = UDim2.new(1, 0, 1, 0)
    Page.BackgroundTransparency = 1
    Page.Visible = false
    Page.ScrollBarThickness = 2
    Page.CanvasSize = UDim2.new(0, 0, 0, 0)
    Page.ScrollBarImageColor3 = Color3.fromRGB(255, 255, 255)
    local Layout = Instance.new("UIListLayout", Page)
    Layout.Padding = UDim.new(0, 5)
    
    Layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        Page.CanvasSize = UDim2.new(0, 0, 0, Layout.AbsoluteContentSize.Y + 10)
    end)
    
    Pages[name] = Page
    return Page
end

local CombatPage = CreatePage("Combat")
local SilentPage = CreatePage("Silent")
local WhitelistPage = CreatePage("Whitelist")
local VisualPage = CreatePage("Visuals")
local ESPPage = CreatePage("ESP")
local TeleportPage = CreatePage("Teleport")
local SpeedPage = CreatePage("Speed")
local FPSPage = CreatePage("FPS")
local AvatarPage = CreatePage("Avatar")
local SettingsPage = CreatePage("Settings")

local function ShowPage(name)
    for _, p in pairs(Pages) do p.Visible = false end
    Pages[name].Visible = true
end

local function CreateTabBtn(name)
    local btn = Instance.new("TextButton", SidebarScroll)
    btn.Size = UDim2.new(0.9, 0, 0, 32)
    btn.Text = name
    btn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.Font = Enum.Font.GothamSemibold
    btn.TextSize = 11
    Instance.new("UICorner", btn)
    btn.MouseButton1Click:Connect(function() ShowPage(name) end)
end

CreateTabBtn("Combat")
CreateTabBtn("Silent")
CreateTabBtn("Whitelist")
CreateTabBtn("Visuals")
CreateTabBtn("ESP")
CreateTabBtn("Teleport")
CreateTabBtn("Speed") 
CreateTabBtn("FPS")
CreateTabBtn("Avatar")
CreateTabBtn("Settings")
ShowPage("Combat")

-- [[ COMPONENTS ]] --
local function CreateHeader(parent, text)
    local l = Instance.new("TextLabel", parent)
    l.Size = UDim2.new(0.85, 0, 0, 30)
    l.Text = "‚Äî " .. text .. " ‚Äî"
    l.BackgroundTransparency = 1
    l.TextColor3 = Color3.fromRGB(180, 180, 180)
    l.Font = Enum.Font.GothamBold
    l.TextSize = 13
end

local function CreateButton(parent, text, callback)
    local btn = Instance.new("TextButton", parent)
    btn.Size = UDim2.new(0.95, 0, 0, 35)
    btn.Text = text
    btn.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.Font = Enum.Font.Gotham
    btn.TextSize = 12
    Instance.new("UICorner", btn)
    btn.MouseButton1Click:Connect(callback)
    return btn
end

local statusBars = {}

local function CreateToggle(parent, text, bindType, default, callback, hasColor, colorCallback)
    local frame = Instance.new("Frame", parent)
    frame.Size = UDim2.new(0.95, 0, 0, 35)
    frame.BackgroundTransparency = 1
    
    local status = Instance.new("Frame", frame)
    status.Size = UDim2.new(0, 6, 0.6, 0)
    status.Position = UDim2.new(0, 2, 0.2, 0)
    status.BackgroundColor3 = default and Color3.fromRGB(255, 255, 0) or Color3.fromRGB(255, 0, 0)
    Instance.new("UICorner", status)
    
    if text == "Triggerbot" then statusBars.Trigger = status
    elseif text == "Flamelock" then statusBars.Flame = status
    elseif text == "Mouselock" then statusBars.Magnet = status
    elseif text == "Speed Master" then statusBars.Speed = status
    elseif text == "FPS Unlocker" then statusBars.FPS = status end
    
    local btn = Instance.new("TextButton", frame)
    btn.Size = UDim2.new(1, -12, 1, 0)
    btn.Position = UDim2.new(0, 12, 0, 0)
    btn.Text = text .. (default and ": ON" or ": OFF")
    btn.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    btn.TextColor3 = default and Color3.fromRGB(255, 20, 147) or Color3.new(1,1,1)
    btn.Font = Enum.Font.Gotham
    btn.TextSize = 12
    Instance.new("UICorner", btn)
    
    local state = default
    btn.MouseButton1Click:Connect(function()
        state = not state
        btn.Text = text .. (state and ": ON" or ": OFF")
        btn.TextColor3 = state and Color3.fromRGB(255, 20, 147) or Color3.new(1,1,1)
        status.BackgroundColor3 = state and Color3.fromRGB(255, 255, 0) or Color3.fromRGB(255, 0, 0)
        callback(state)
    end)

    if hasColor then
        local cp = Instance.new("TextButton", btn)
        cp.Size = UDim2.new(0, 16, 0, 16)
        cp.Position = UDim2.new(1, -90, 0.5, -8)
        cp.BackgroundColor3 = Color3.fromRGB(255, 20, 147)
        cp.Text = ""
        Instance.new("UICorner", cp)
        
        local palette = {Color3.fromRGB(20, 130, 255), Color3.new(1,0,0), Color3.new(0,1,0), Color3.new(0,0,1), Color3.new(1,1,1), Color3.new(1,1,0), Color3.new(1,0,1)}
        local cIdx = 1
        cp.MouseButton1Click:Connect(function()
            cIdx = (cIdx % #palette) + 1
            cp.BackgroundColor3 = palette[cIdx]
            colorCallback(palette[cIdx])
        end)
    end

    if bindType then
        local bindBtn = Instance.new("TextButton", btn)
        bindBtn.Size = UDim2.new(0, 60, 0.8, 0)
        bindBtn.Position = UDim2.new(1, -65, 0.1, 0)
        bindBtn.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
        local initialKey = "N/A"
        if bindType == "Magnet" then initialKey = MagnetSettings.LockKey.Name
        elseif bindType == "Trigger" then initialKey = TriggerSettings.TriggerKey.Name
        elseif bindType == "Flame" then initialKey = FlameConfig.MouseLockKey.Name
        elseif bindType == "Speed" then initialKey = FlameConfig.WalkSpeedKey.Name
        elseif bindType == "UI" then initialKey = GlobalSettings.HideAllKey.Name 
        elseif bindType == "FreeMouse" then initialKey = TeleportSettings.FreeMouseTPKey.Name end
        bindBtn.Text = "["..initialKey.."]"
        bindBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
        bindBtn.Font = Enum.Font.Code
        bindBtn.TextSize = 10
        Instance.new("UICorner", bindBtn)
        local listening = false
        bindBtn.MouseButton1Click:Connect(function() listening = true; bindBtn.Text = "..." end)
        UserInputService.InputBegan:Connect(function(io)
            if listening and io.UserInputType == Enum.UserInputType.Keyboard then
                listening = false
                local newKey = io.KeyCode
                if bindType == "Magnet" then MagnetSettings.LockKey = newKey
                elseif bindType == "Trigger" then TriggerSettings.TriggerKey = newKey
                elseif bindType == "Flame" then FlameConfig.MouseLockKey = newKey
                elseif bindType == "Speed" then FlameConfig.WalkSpeedKey = newKey
                elseif bindType == "UI" then GlobalSettings.HideAllKey = newKey 
                elseif bindType == "FreeMouse" then TeleportSettings.FreeMouseTPKey = newKey end
                bindBtn.Text = "["..newKey.Name.."]"
            end
        end)
    end
end

local function CreateModeSelector(parent, label, default, callback)
    local frame = Instance.new("Frame", parent)
    frame.Size = UDim2.new(0.95, 0, 0, 35)
    frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    Instance.new("UICorner", frame)
    local title = Instance.new("TextLabel", frame)
    title.Size = UDim2.new(0.4, 0, 1, 0); title.Position = UDim2.new(0.05, 0, 0, 0); title.Text = label .. ":"; title.TextColor3 = Color3.new(1,1,1); title.BackgroundTransparency = 1; title.Font = Enum.Font.Gotham; title.TextSize = 12; title.TextXAlignment = Enum.TextXAlignment.Left
    local btn = Instance.new("TextButton", frame)
    btn.Size = UDim2.new(0.5, 0, 1, 0); btn.Position = UDim2.new(0.45, 0, 0, 0); btn.BackgroundTransparency = 1; btn.Font = Enum.Font.GothamSemibold; btn.TextSize = 12
    local function updateText(mode)
        btn.RichText = true
        btn.Text = mode == "Hold" and '<font color="rgb(147, 179, 255)">Hold</font> / <font color="rgb(100, 100, 100)">Toggle</font>' or '<font color="rgb(100, 100, 100)">Hold</font> / <font color="rgb(147, 179, 255)">Toggle</font>'
    end
    local current = default; updateText(current)
    btn.MouseButton1Click:Connect(function() current = (current == "Hold" and "Toggle" or "Hold"); updateText(current); callback(current) end)
end

local function CreateSlider(parent, text, min, max, default, callback)
    local sliderFrame = Instance.new("Frame", parent)
    sliderFrame.Size = UDim2.new(0.95, 0, 0, 55)
    sliderFrame.BackgroundTransparency = 1
    local label = Instance.new("TextLabel", sliderFrame); label.Size = UDim2.new(1, 0, 0, 20); label.Text = text .. ": " .. default; label.TextColor3 = Color3.new(1,1,1); label.BackgroundTransparency = 1; label.Font = Enum.Font.Gotham; label.TextSize = 12; label.TextXAlignment = Enum.TextXAlignment.Left
    local tray = Instance.new("Frame", sliderFrame); tray.Size = UDim2.new(1, 0, 0, 8); tray.Position = UDim2.new(0, 0, 0, 30); tray.BackgroundColor3 = Color3.fromRGB(30, 30, 30); Instance.new("UICorner", tray)
    local fill = Instance.new("Frame", tray); fill.Size = UDim2.new((default - min) / (max - min), 0, 1, 0); fill.BackgroundColor3 = Color3.fromRGB(20, 141, 255); Instance.new("UICorner", fill)
    local function update(input)
        local pos = math.clamp((input.Position.X - tray.AbsolutePosition.X) / tray.AbsoluteSize.X, 0, 1)
        local val = math.floor(min + (max - min) * pos)
        fill.Size = UDim2.new(pos, 0, 1, 0); label.Text = text .. ": " .. val; callback(val)
    end
    local dragging = false
    tray.InputBegan:Connect(function(input) 
        if input.UserInputType == Enum.UserInputType.MouseButton1 then 
            dragging = true 
            MainFrame.Active = false 
            update(input) 
        end 
    end)
    UserInputService.InputChanged:Connect(function(input) if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then update(input) end end)
    UserInputService.InputEnded:Connect(function(input) 
        if input.UserInputType == Enum.UserInputType.MouseButton1 then 
            dragging = false 
            MainFrame.Active = true 
        end 
    end)
end

-- [[ AVATAR UTILS ]] --
local function WearItem(id)
    pcall(function()
        local head = LocalPlayer.Character:FindFirstChild("Head")
        if head then
            for _, v in pairs(head:GetChildren()) do
                if v:IsA("SurfaceAppearance") or v:IsA("FaceControls") or v:IsA("Decal") then v:Destroy() end
            end
            local face = Instance.new("Decal", head)
            face.Name = "face"
            face.Texture = "rbxassetid://" .. id
        end
    end)
end

local function ApplyHeadless()
    if AvatarSettings.HeadlessActive and LocalPlayer.Character then
        local head = LocalPlayer.Character:FindFirstChild("Head")
        if head then
            head.Transparency = 1
            for _, v in pairs(head:GetChildren()) do
                if v:IsA("Decal") or v:IsA("BasePart") or v:IsA("Attachment") then
                    pcall(function() v.Transparency = 1 end)
                end
            end
        end
    end
end

-- [[ WHITELIST SYSTEM (FIXED SCROLL) ]] --
local function UpdateWhitelistUI()
    WhitelistPage:ClearAllChildren()
    local Layout = Instance.new("UIListLayout", WhitelistPage)
    Layout.Padding = UDim.new(0, 5)
    Layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    
    CreateHeader(WhitelistPage, "PLAYER LIST")
    
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer then
            local btn = Instance.new("TextButton", WhitelistPage)
            btn.Size = UDim2.new(0.95, 0, 0, 35)
            btn.BackgroundColor3 = Whitelist[plr.UserId] and Color3.fromRGB(20, 89, 255) or Color3.fromRGB(25, 25, 25)
            btn.Text = plr.DisplayName .. " (@" .. plr.Name .. ")"
            btn.TextColor3 = Color3.new(1,1,1)
            btn.Font = Enum.Font.Gotham
            btn.TextSize = 11
            Instance.new("UICorner", btn)
            
            btn.MouseButton1Click:Connect(function()
                Whitelist[plr.UserId] = not Whitelist[plr.UserId]
                btn.BackgroundColor3 = Whitelist[plr.UserId] and Color3.fromRGB(0, 75, 255) or Color3.fromRGB(25, 25, 25)
            end)
        end
    end
    
    -- Force Canvas Update
    WhitelistPage.CanvasSize = UDim2.new(0, 0, 0, Layout.AbsoluteContentSize.Y + 20)
end

Players.PlayerAdded:Connect(UpdateWhitelistUI)
Players.PlayerRemoving:Connect(UpdateWhitelistUI)
UpdateWhitelistUI()

-- [[ PAGE POPULATION ]] --
CreateHeader(CombatPage, "TRIGGERBOT")
CreateToggle(CombatPage, "Triggerbot", "Trigger", false, function(v) TriggerSettings.MasterEnabled = v end)
CreateModeSelector(CombatPage, "Activation", "Hold", function(m) TriggerSettings.Mode = m end)

CreateHeader(CombatPage, "FLAMELOCK")
CreateToggle(CombatPage, "Flamelock", "Flame", false, function(v) FlameConfig.MasterLock = v end)
CreateModeSelector(CombatPage, "Activation", "Hold", function(m) FlameConfig.ActivationType = m end)
CreateToggle(CombatPage, "Use Right Click", nil, false, function(v) FlameConfig.UseRightClick = v end)

CreateHeader(CombatPage, "MAGNET/LOCK")
CreateToggle(CombatPage, "Mouselock", "Magnet", false, function(v) MagnetSettings.MasterEnabled = v if not v then MagnetSettings.Enabled = false end end)

-- [[ SILENT PAGE ]] --
CreateHeader(SilentPage, "SILENT AIM V4")
CreateToggle(SilentPage, "Silent Aim", nil, false, function(v) getgenv().SilentAim = v end)
CreateToggle(SilentPage, "Show FOV", nil, false, function(v) getgenv().ShowFOV = v end)
CreateToggle(SilentPage, "Target Knocked", nil, false, function(v) getgenv().TargetKnocked = v end)
CreateSlider(SilentPage, "Lock Radius", 0, 1000, 100, function(v) getgenv().FOVRadius = v end)

CreateHeader(VisualPage, "ATMOSPHERE PRESETS")
local resetBtn = Instance.new("TextButton", VisualPage)
resetBtn.Size = UDim2.new(0.95, 0, 0, 30); resetBtn.Text = "Reset Lighting"; resetBtn.BackgroundColor3 = Color3.fromRGB(35, 35, 35); resetBtn.TextColor3 = Color3.new(1,1,1); Instance.new("UICorner", resetBtn)
resetBtn.MouseButton1Click:Connect(function()
    for _, v in ipairs(Lighting:GetChildren()) do if v:IsA("Atmosphere") then v:Destroy() end end
    if OrigAtmosphere then OrigAtmosphere:Clone().Parent = Lighting end
    Lighting.FogStart = OrigFogStart; Lighting.FogEnd = OrigFogEnd; Lighting.FogColor = OrigFogColor
end)

for name, data in pairs(FogPresets) do
    local btn = Instance.new("TextButton", VisualPage)
    btn.Size = UDim2.new(0.95, 0, 0, 30); btn.Text = name; btn.BackgroundColor3 = Color3.fromRGB(20, 20, 20); btn.TextColor3 = data.Color; Instance.new("UICorner", btn)
    btn.MouseButton1Click:Connect(function()
        for _, v in ipairs(Lighting:GetChildren()) do if v:IsA("Atmosphere") then v:Destroy() end end
        local atm = Instance.new("Atmosphere", Lighting); atm.Color = data.Color; atm.Density = data.Density; atm.Haze = 4
        Lighting.FogStart = 30; Lighting.FogEnd = 200
    end)
end

CreateHeader(ESPPage, "ESP SETTINGS")
CreateToggle(ESPPage, "Master ESP", nil, false, function(v) ESPSettings.Enabled = v end)
CreateToggle(ESPPage, "Boxes", nil, false, function(v) ESPSettings.Box = v end, true, function(c) ESPSettings.BoxColor = c end)
CreateToggle(ESPPage, "Skeletons", nil, false, function(v) ESPSettings.Skeleton = v end, true, function(c) ESPSettings.SkeletonColor = c end)
CreateToggle(ESPPage, "Names", nil, false, function(v) ESPSettings.Name = v end, true, function(c) ESPSettings.NameColor = c end)
CreateToggle(ESPPage, "Health Bars", nil, false, function(v) ESPSettings.Health = v end)
CreateToggle(ESPPage, "Distance", nil, false, function(v) ESPSettings.Distance = v end)

CreateHeader(TeleportPage, "MOUSE TELEPORT")
CreateToggle(TeleportPage, "FreeMouse TP Key", "FreeMouse", false, function(v) TeleportSettings.Enabled = v end)

CreateHeader(TeleportPage, "LOCATION TELEPORTS")
for name, cf in pairs(locations) do
    local btn = Instance.new("TextButton", TeleportPage)
    btn.Size = UDim2.new(0.95, 0, 0, 35); btn.Text = name; btn.BackgroundColor3 = Color3.fromRGB(25, 25, 25); btn.TextColor3 = Color3.fromRGB(255, 105, 180); Instance.new("UICorner", btn)
    btn.MouseButton1Click:Connect(function() if LocalPlayer.Character then LocalPlayer.Character:PivotTo(cf + Vector3.new(0, 0.5, 0)) end end)
end

CreateHeader(SpeedPage, "MOVEMENT")
CreateToggle(SpeedPage, "Speed Master", "Speed", false, function(v) FlameConfig.MasterSpeed = v end)
CreateSlider(SpeedPage, "Speed Dial", 16, 1000, 100, function(v) FlameConfig.WalkSpeedValue = v end)

CreateHeader(FPSPage, "PERFORMANCE")
CreateToggle(FPSPage, "FPS Unlocker", nil, true, function(v) FPSSettings.MasterEnabled = v end)
CreateSlider(FPSPage, "Target FPS", 60, 1500, 240, function(v) FPSSettings.TargetFPS = v end)
local fpsShow = Instance.new("TextLabel", FPSPage)
fpsShow.Size = UDim2.new(0.95, 0, 0, 30); fpsShow.BackgroundTransparency = 1; fpsShow.TextColor3 = Color3.new(0,1,0); fpsShow.Font = Enum.Font.Code; fpsShow.TextSize = 14; fpsShow.Text = "Current FPS: 0"

CreateHeader(AvatarPage, "AVATAR STUFF")
CreateButton(AvatarPage, "Super Super Happy Face", function() WearItem(494290547) end)
CreateButton(AvatarPage, "Playful Vampire", function() WearItem(2409281591) end)

CreateToggle(AvatarPage, "Headless", nil, false, function(v) 
    AvatarSettings.HeadlessActive = v 
    if v then ApplyHeadless() else
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Head") then
            LocalPlayer.Character.Head.Transparency = 0
            for _, v in pairs(LocalPlayer.Character.Head:GetChildren()) do
                if v:IsA("Decal") then v.Transparency = 0 end
            end
        end
    end
end)

CreateToggle(AvatarPage, "Korblox Toggle", nil, false, function(v) 
    AvatarSettings.KorbloxActive = v
    local char = LocalPlayer.Character
    if not char then return end
    if v then
        for _, p in pairs({"RightLowerLeg", "RightUpperLeg", "RightFoot"}) do
            if char:FindFirstChild(p) then char[p].Transparency = 1 end
        end
        local leg = game:GetObjects("rbxassetid://139666332")[1]
        leg.Name = "PG_Korblox"
        leg.Parent = char
    else
        if char:FindFirstChild("PG_Korblox") then char.PG_Korblox:Destroy() end
        for _, p in pairs({"RightLowerLeg", "RightUpperLeg", "RightFoot"}) do
            if char:FindFirstChild(p) then char[p].Transparency = 0 end
        end
    end
end)

CreateToggle(AvatarPage, "Toggle Sparkles", nil, false, function(v)
    local hrp = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if v then
        local s = Instance.new("Sparkles", hrp)
        s.Name = "PG_Sparkle"
        s.SparkleColor = AvatarSettings.SparkleColor
        s.Enabled = true
    else
        if hrp:FindFirstChild("PG_Sparkle") then hrp.PG_Sparkle:Destroy() end
    end
end, true, function(c)
    AvatarSettings.SparkleColor = c
    local hrp = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if hrp and hrp:FindFirstChild("PG_Sparkle") then hrp.PG_Sparkle.SparkleColor = c end
end)

CreateSlider(AvatarPage, "Sparkle Size", 1, 20, 1, function(v)
    AvatarSettings.SparkleSize = v
end)

CreateHeader(SettingsPage, "INTERFACE")
CreateToggle(SettingsPage, "Menu Keybind", "UI", true, function() end)

-- [[ COMBAT LOGIC UTILS ]] --
local function isBlacklisted()
    local char = LocalPlayer.Character
    local tool = char and char:FindFirstChildOfClass("Tool")
    if tool then
        local tName = tool.Name:lower()
        for _, name in pairs(TriggerSettings.Blacklist) do
            if string.find(tName, name:lower()) then return true end
        end
    end
    return false
end

local function GetClosestToCursor(radius)
    local Target = nil
    local ShortestDistance = radius or getgenv().FOVRadius
    for _, v in pairs(Players:GetPlayers()) do
        if v ~= LocalPlayer and not Whitelist[v.UserId] and v.Character and v.Character:FindFirstChild("HumanoidRootPart") then
            local hum = v.Character:FindFirstChild("Humanoid")
            local bodyEffects = v.Character:FindFirstChild("BodyEffects")
            local isKO = bodyEffects and bodyEffects:FindFirstChild("K.O") and bodyEffects["K.O"].Value
            local canTarget = false
            if hum and hum.Health > 0 then
                if getgenv().TargetKnocked then
                    canTarget = true
                else
                    if not isKO then canTarget = true end
                end
            end
            if canTarget then
                local ScreenPos, OnScreen = Camera:WorldToViewportPoint(v.Character.HumanoidRootPart.Position)
                if OnScreen then
                    local MousePos = UserInputService:GetMouseLocation()
                    local Dist = (MousePos - Vector2.new(ScreenPos.X, ScreenPos.Y)).Magnitude
                    if Dist < ShortestDistance then
                        ShortestDistance = Dist
                        Target = v
                    end
                end
            end
        end
    end
    return Target
end

local function getFlameTarget()
    local target = GetClosestToCursor(math.huge)
    return target and target.Character and target.Character:FindFirstChild(FlameConfig.HitPart) or nil
end

local function getMagnetTarget()
    local target = nil
    local shortestDistance = math.huge
    local mousePos = UserInputService:GetMouseLocation()

    for _, v in pairs(Players:GetPlayers()) do
        if v ~= LocalPlayer and not Whitelist[v.UserId] and v.Character and v.Character:FindFirstChild(MagnetSettings.TargetPart) then
            local pos, _ = Camera:WorldToViewportPoint(v.Character[MagnetSettings.TargetPart].Position)
            local distance = (Vector2.new(pos.X, pos.Y) - mousePos).Magnitude
            if distance < shortestDistance then
                target = v
                shortestDistance = distance
            end
        end
    end
    return target and target.Character and target.Character:FindFirstChild(MagnetSettings.TargetPart) or nil
end

local flameTargetPart = nil
local magTarget = nil

-- [[ FULL ESP ENGINE ]] --
local function CreateDrawing(class, props)
    local d = Drawing.new(class)
    for i, v in pairs(props) do d[i] = v end
    return d
end

local staticBoneList = {{"Head","UpperTorso"},{"UpperTorso","LowerTorso"},{"UpperTorso","LeftUpperArm"},{"LeftUpperArm","LeftLowerArm"},{"UpperTorso","RightUpperArm"},{"RightUpperArm","RightLowerArm"},{"LowerTorso","LeftUpperLeg"},{"LeftUpperLeg","LeftLowerLeg"},{"LowerTorso","RightUpperLeg"},{"RightUpperLeg","RightLowerLeg"}}

local ESPObjects = {}
local function AddESP(plr)
    local objects = {
        Box = CreateDrawing("Square", {Thickness = 1, Filled = false, Color = ESPSettings.BoxColor, Visible = false}),
        Name = CreateDrawing("Text", {Size = 13, Center = true, Outline = true, Color = ESPSettings.NameColor, Visible = false}),
        Health = CreateDrawing("Line", {Thickness = 2, Color = Color3.new(0,1,0), Visible = false}),
        HealthBg = CreateDrawing("Line", {Thickness = 2, Color = Color3.new(0,0,0), Visible = false}),
        Bones = {}
    }
    for i=1, #staticBoneList do objects.Bones[i] = CreateDrawing("Line", {Thickness = 1, Color = ESPSettings.SkeletonColor, Visible = false}) end
    ESPObjects[plr] = objects
end

Players.PlayerAdded:Connect(AddESP); for _, plr in pairs(Players:GetPlayers()) do if plr ~= LocalPlayer then AddESP(plr) end end
Players.PlayerRemoving:Connect(function(plr) if ESPObjects[plr] then for _, v in pairs(ESPObjects[plr]) do if type(v) == "table" then for _, b in pairs(v) do b:Remove() end else v:Remove() end end ESPObjects[plr] = nil end end)

-- [[ INPUT HANDLER ]] --
_G.con = UserInputService.InputBegan:Connect(function(keyc, sp)
    if sp then return end
    
    if keyc.KeyCode == GlobalSettings.HideAllKey then MainFrame.Visible = not MainFrame.Visible end
    
    if keyc.KeyCode == TeleportSettings.FreeMouseTPKey and TeleportSettings.Enabled and Mouse.Hit then
        if LocalPlayer.Character then LocalPlayer.Character:PivotTo(Mouse.Hit + Vector3.new(0, 3, 0)) end
    end

    if FlameConfig.MasterLock then
        local isTrigger = (FlameConfig.UseRightClick and keyc.UserInputType == Enum.UserInputType.MouseButton2) or (not FlameConfig.UseRightClick and keyc.KeyCode == FlameConfig.MouseLockKey)
        if isTrigger then
            flameTargetPart = getFlameTarget()
            if FlameConfig.ActivationType == "Hold" then FlameConfig.LockActive = true else FlameConfig.LockActive = not FlameConfig.LockActive end
        end
    end

    if MagnetSettings.MasterEnabled and keyc.KeyCode == MagnetSettings.LockKey then 
        MagnetSettings.Enabled = not MagnetSettings.Enabled 
        magTarget = MagnetSettings.Enabled and getMagnetTarget() or nil
    end

    if TriggerSettings.MasterEnabled and keyc.KeyCode == TriggerSettings.TriggerKey then
        if TriggerSettings.Mode == "Hold" then TriggerSettings.Active = true else TriggerSettings.Active = not TriggerSettings.Active end
    end

    if FlameConfig.MasterSpeed and keyc.KeyCode == FlameConfig.WalkSpeedKey then 
        FlameConfig.SpeedActive = not FlameConfig.SpeedActive 
    end
end)

UserInputService.InputEnded:Connect(function(io)
    if FlameConfig.MasterLock and FlameConfig.ActivationType == "Hold" then
        local isTrigger = (FlameConfig.UseRightClick and io.UserInputType == Enum.UserInputType.MouseButton2) or (not FlameConfig.UseRightClick and io.KeyCode == FlameConfig.MouseLockKey)
        if isTrigger then FlameConfig.LockActive = false; flameTargetPart = nil end
    end
    if TriggerSettings.MasterEnabled and TriggerSettings.Mode == "Hold" and io.KeyCode == TriggerSettings.TriggerKey then TriggerSettings.Active = false end
end)

-- [[ SILENT AIM HOOK ]] --
local oldIndex = nil
oldIndex = hookmetamethod(game, "__index", function(self, Index)
    if not checkcaller() and getgenv().SilentAim and self == Mouse and (Index == "Hit" or Index == "Target") then
        local Target = GetClosestToCursor()
        if Target and Target.Character and Target.Character:FindFirstChild("HumanoidRootPart") then
            return (Index == "Hit" and Target.Character.HumanoidRootPart.CFrame or Target.Character.HumanoidRootPart)
        end
    end
    return oldIndex(self, Index)
end)

-- [[ CORE RENDER LOOP ]] --
local loopFrameCount = 0
local lastUpdate = tick()

-- High-performance FPS Loop (Traced Logic Implementation)
task.spawn(function()
    while task.wait(0.1) do
        if FPSSettings.MasterEnabled then
            setfpscap(FPSSettings.TargetFPS)
        end
    end
end)

RunService.RenderStepped:Connect(function()
    loopFrameCount = loopFrameCount + 1
    if tick() - lastUpdate >= 1 then 
        fpsShow.Text = "Current FPS: " .. loopFrameCount
        loopFrameCount = 0
        lastUpdate = tick()
    end

    if AvatarSettings.HeadlessActive then ApplyHeadless() end

    local function setSignal(signal, master, active)
        if signal then
            if not master then 
                signal.BackgroundColor3 = Color3.fromRGB(255, 0, 0) 
            elseif master and not active then 
                signal.BackgroundColor3 = Color3.fromRGB(255, 255, 0) 
            else 
                signal.BackgroundColor3 = Color3.fromRGB(0, 255, 0) 
            end
        end
    end

    -- FLAMELOCK LOGIC
    local flameActive = false
    if FlameConfig.MasterLock and FlameConfig.LockActive and flameTargetPart and flameTargetPart.Parent then
        local targetPlr = Players:GetPlayerFromCharacter(flameTargetPart.Parent)
        if targetPlr and not Whitelist[targetPlr.UserId] then
            local targetPos = flameTargetPart.Position + (flameTargetPart.Velocity * FlameConfig.Prediction)
            local offset = (Camera.CFrame.RightVector * FlameConfig.LeftOffset) + Vector3.new(0, FlameConfig.UpOffset, 0)
            local screenPos, onScreen = Camera:WorldToViewportPoint(targetPos + offset)
            if onScreen then
                flameActive = true
                local mousePos = UserInputService:GetMouseLocation()
                mousemoverel((screenPos.X - mousePos.X) * FlameConfig.Smoothness, (screenPos.Y - mousePos.Y) * FlameConfig.Smoothness)
            end
        else
            flameTargetPart = nil
        end
    end
    setSignal(statusBars.Flame, FlameConfig.MasterLock, flameActive)

    -- MAGNET LOGIC
    local magActive = false
    if MagnetSettings.MasterEnabled and MagnetSettings.Enabled then
        if magTarget and magTarget.Parent then
            local targetPlr = Players:GetPlayerFromCharacter(magTarget.Parent)
            if targetPlr and not Whitelist[targetPlr.UserId] then
                magActive = true
                local targetPos, _ = Camera:WorldToViewportPoint(magTarget.Position)
                local mouseLocation = UserInputService:GetMouseLocation()
                local targetVec = Vector2.new(targetPos.X, targetPos.Y)
                local delta = (targetVec - mouseLocation) * MagnetSettings.MagnetStrength
                if mousemoverel then mousemoverel(delta.X, delta.Y) end
            else
                MagnetSettings.Enabled = false
                magTarget = nil
            end
        else
            MagnetSettings.Enabled = false
            magTarget = nil
        end
    end
    setSignal(statusBars.Magnet, MagnetSettings.MasterEnabled, magActive)

    -- TRIGGERBOT LOGIC
    local trigActive = false
    if TriggerSettings.MasterEnabled and TriggerSettings.Active and not isBlacklisted() then
        if Mouse.Target and Mouse.Target.Parent:FindFirstChild("Humanoid") then
            local targetPlr = Players:GetPlayerFromCharacter(Mouse.Target.Parent)
            if not targetPlr or (targetPlr and not Whitelist[targetPlr.UserId]) then
                trigActive = true
                mouse1press()
                task.wait(TriggerSettings.ClickDelay)
                mouse1release()
            end
        end
    end
    setSignal(statusBars.Trigger, TriggerSettings.MasterEnabled, trigActive)

    -- SPEED & FOV
    local currentSpeedActive = false
    if FlameConfig.MasterSpeed and FlameConfig.SpeedActive and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid.WalkSpeed = FlameConfig.WalkSpeedValue
        currentSpeedActive = true
    end
    setSignal(statusBars.Speed, FlameConfig.MasterSpeed, currentSpeedActive)

    setSignal(statusBars.FPS, FPSSettings.MasterEnabled, FPSSettings.MasterEnabled)

    FOVCircle.Visible = getgenv().ShowFOV
    FOVCircle.Radius = getgenv().FOVRadius
    FOVCircle.Position = UserInputService:GetMouseLocation()
    
    -- ESP UPDATE LOOP
    if ESPSettings.Enabled then
        for plr, obj in pairs(ESPObjects) do
            if plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                local char = plr.Character
                local hrp = char.HumanoidRootPart
                local hum = char:FindFirstChild("Humanoid")
                local pos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
                local dist = (Camera.CFrame.Position - hrp.Position).Magnitude
                
                if onScreen and dist <= ESPSettings.MaxDistance then
                    local distScale = 1 / pos.Z
                    local size = Vector2.new(2500 * distScale, 4500 * distScale)
                    local top = Vector2.new(pos.X - size.X / 2, pos.Y - size.Y / 2)

                    if ESPSettings.Box then
                        obj.Box.Size = size
                        obj.Box.Position = top
                        obj.Box.Color = ESPSettings.BoxColor
                        obj.Box.Visible = true
                    else obj.Box.Visible = false end
                    
                    if ESPSettings.Health and hum then
                        obj.HealthBg.Visible = true
                        obj.HealthBg.From = Vector2.new(top.X - 5, top.Y + size.Y)
                        obj.HealthBg.To = Vector2.new(top.X - 5, top.Y)
                        obj.Health.Visible = true
                        obj.Health.From = Vector2.new(top.X - 5, top.Y + size.Y)
                        obj.Health.To = Vector2.new(top.X - 5, top.Y + size.Y - (size.Y * (hum.Health/hum.MaxHealth)))
                        obj.Health.Color = Color3.fromHSV(hum.Health/hum.MaxHealth * 0.3, 1, 1)
                    else obj.Health.Visible = false; obj.HealthBg.Visible = false end

                    if ESPSettings.Skeleton then
                        for i, bone in pairs(staticBoneList) do
                            local p1, p2 = char:FindFirstChild(bone[1]), char:FindFirstChild(bone[2])
                            if p1 and p2 then
                                local b1, b2 = Camera:WorldToViewportPoint(p1.Position), Camera:WorldToViewportPoint(p2.Position)
                                obj.Bones[i].Visible = true
                                obj.Bones[i].From = Vector2.new(b1.X, b1.Y)
                                obj.Bones[i].To = Vector2.new(b2.X, b2.Y)
                                obj.Bones[i].Color = ESPSettings.SkeletonColor
                            else obj.Bones[i].Visible = false end
                        end
                    else for _,b in pairs(obj.Bones) do b.Visible = false end end

                    if ESPSettings.Name then
                        obj.Name.Text = (Whitelist[plr.UserId] and "[WHITELISTED] " or "") .. plr.Name .. (ESPSettings.Distance and " [" .. math.floor(dist) .. "m]" or "")
                        obj.Name.Position = Vector2.new(pos.X, top.Y - 15)
                        obj.Name.Color = ESPSettings.NameColor
                        obj.Name.Visible = true
                    else obj.Name.Visible = false end
                else
                    obj.Box.Visible = false; obj.Name.Visible = false; obj.Health.Visible = false; obj.HealthBg.Visible = false
                    for _,b in pairs(obj.Bones) do b.Visible = false end
                end
            end
        end
    else
        for _, obj in pairs(ESPObjects) do 
            obj.Box.Visible = false; obj.Name.Visible = false; obj.Health.Visible = false; obj.HealthBg.Visible = false
            for _,b in pairs(obj.Bones) do b.Visible = false end
        end
    end
end)
